# Fixes & Changes — 2026-01-31

## 1. Customer Orders Tree Page

**Problem:** No way to browse Shopify customers and their orders from the app admin panel.

**Solution:** Created a new route `/app/customers` (`app/routes/app.customers.tsx`) that:

- Fetches first 20 customers via Shopify Admin GraphQL API on page load
- Supports search by name/email via action `search-customers`
- Loads all orders for a selected customer via action `get-orders`
- Displays orders as expandable tree: order header (name, date, total, financial/fulfillment status) → line items (title, variant, quantity, price, SKU)
- Uses `useFetcher` for non-navigating data loads
- Uses `s-page`, `s-section`, `s-button`, `s-text-field` Shopify components

**GraphQL queries used:**

```graphql
# Customers list
query customers($first: Int!, $query: String) {
  customers(first: $first, query: $query) {
    nodes { id displayName email numberOfOrders }
  }
}

# Customer orders with line items
query customerOrders($id: ID!) {
  customer(id: $id) {
    displayName
    email
    orders(first: 50, sortKey: CREATED_AT, reverse: true) {
      nodes {
        id name createdAt
        totalPriceSet { shopMoney { amount currencyCode } }
        displayFinancialStatus displayFulfillmentStatus
        lineItems(first: 50) {
          nodes {
            title quantity
            originalUnitPriceSet { shopMoney { amount currencyCode } }
            variant { id title sku }
          }
        }
      }
    }
  }
}
```

**Nav update:** Added `<s-link href="/app/customers">Customers</s-link>` to `app/routes/app.tsx`.

---

## 2. Metafield Key Mismatch Fix

**File:** `app/service/sync/products/build-product-input.ts`

**Problem:** The metafield key for sort order was set as `sort-order` (hyphen) but the Shopify metafield definition uses `sort_order` (underscore). This caused the value to not be saved during product sync.

**Fix:** Changed key from `"sort-order"` to `"sort_order"`:

```typescript
// Before
{ key: "sort-order", value: sortOrder.toString(), namespace: "custom", type: "number_integer" }

// After
{ key: "sort_order", value: sortOrder.toString(), namespace: "custom", type: "number_integer" }
```

**Lesson:** Always verify that metafield keys in code exactly match the metafield definitions created in Shopify admin (including hyphens vs underscores).

---

## 3. Deleting All Records from Prisma Table

**Problem:** Needed to clear all rows from `ProductMap` table to re-sync products.

**Solution:**

```bash
npx prisma db execute --schema ./prisma/schema.prisma --stdin <<< 'DELETE FROM "ProductMap";'
```

**Note:** Table name must be quoted (`"ProductMap"`) to preserve case sensitivity in the SQL query. Without quotes, the database may look for `productmap` (lowercase) and fail with error `P1014`.
