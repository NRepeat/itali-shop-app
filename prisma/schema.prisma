generator client {
  provider      = "prisma-client"
  output        = "./generated/app_client"
  moduleFormat  = "esm"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model MetafieldDefinition {
  id          String   @id @default(cuid())
  metafieldId String   @unique
  key         String   @unique
  type        String
  description String?
  namespace   String?
  ownerType   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
}

model MetaobjectDefinition {
  id          String   @id @default(cuid())
  metaobjecDefinitionId String   @unique
  name      String   @unique
  type        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
}

model Collection {
  id          String   @id @default(cuid())
  metaobjectId String   @unique
  handle      String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
}
model Metaobject {
  id          String   @id @default(cuid())
  metaobjectId String   @unique
  handle      String   @unique
  type        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
}

model ProductMap {
  id               String   @id @default(cuid())
  localProductId   Int      @unique
  shopifyProductId String   @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model CustomerMap {
  id                String   @id @default(cuid())
  localCustomerId   Int      @unique
  shopifyCustomerId String   @unique
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model OrderMap {
  id             String   @id @default(cuid())
  localOrderId   Int      @unique
  shopifyOrderId String   @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

enum SubscriptionType {
  PRICE_DROP    // Notify when price drops to target
  BACK_IN_STOCK // Notify when product is back in stock
  ANY_CHANGE    // Notify on any price change
}

// Price tracking subscription
model PriceSubscription {
  id              String           @id @default(cuid())
  email           String
  shopifyProductId String
  shopifyVariantId String?
  subscriptionType SubscriptionType @default(PRICE_DROP)
  targetPrice     Decimal?         @db.Decimal(10, 2)
  isActive        Boolean          @default(true)
  notifiedAt      DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([shopifyProductId])
  @@index([shopifyVariantId])
  @@index([email])
  @@index([subscriptionType])
}

// Price history for products/variants
model PriceHistory {
  id              String   @id @default(cuid())
  shopifyProductId String
  shopifyVariantId String
  price           Decimal  @db.Decimal(10, 2)
  compareAtPrice  Decimal? @db.Decimal(10, 2)
  currencyCode    String   @default("UAH")
  recordedAt      DateTime @default(now())

  @@index([shopifyProductId])
  @@index([shopifyVariantId])
  @@index([recordedAt])
}
